<div class="container">

	<h1 class="primary_title">COMMANDE N¬∞ <%= @order.number %></h1>
	<hr>

	<%= link_to " Retour √† la liste des commandes", admin_orders_path, class: 'btn btn-main' %> 

	<div class="row">
		<div class="col-12 col-md-4">
			<div class="small_order_box">
				<p>ADRESSE DE LIVRAISON</p>
				<p><%= @order.user.full_name%></p>
				<p><%= @order.user.shipping_address.address_1%></p>
				<p><%= @order.user.shipping_address.address_2 %></p>
				<p><%= @order.user.shipping_address.zipcode %> <%= @order.user.shipping_address.city %></p>
				<p><%= @order.user.shipping_address.phone %></p>
			</div>
		</div>
		<div class="col-12 col-md-4">
			<div class="small_order_box">
				<p>ADRESSE DE FACTURATION</p>
				<% if @order.user.billing_address %>
					<p><%= @order.user.full_name%></p>
					<p><%= @order.user.billing_address.address_1 %></p>
					<p><%= @order.user.billing_address.address_2 %></p>
					<p><%= @order.user.billing_address.zipcode %> <%= @order.user.billing_address.city %></p>
					<p><%= @order.user.billing_address.phone %></p>
				<% else %>
					<p><%= @order.user.full_name%></p>
					<p><%= @order.user.shipping_address.address_1%></p>
					<p><%= @order.user.shipping_address.address_2 %></p>
					<p><%= @order.user.shipping_address.zipcode %> <%= @order.user.shipping_address.city %></p>
					<p><%= @order.user.shipping_address.phone %></p>
				<% end %>
			</div>
		</div>
		<div class="col-12 col-md-4">
			<div class="small_order_box">
				<p>Etat de la commande :</p>
				<p><%= t("admin.orders.#{@order.status}") %></p>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-12">
				<table class='table table'style="background-color: #111; color: #AAA;">
<!-- 					<thead>
						<tr>
						<th></th>
						<th>1 - V√©rification</th>
						<th>2 - Traitement</th>
						<th>3 - Action</th>
						<th>4 - Conclusion</th>
					</tr>
					</thead> -->
					<tbody>

					<% if @order.paid? || @order.confirmed? || @order.full_shipped? %>
						<tr>
							<td><h1>‚úÖ</h1></td>
							<td>
								Tout est dispo
							</td>
							<td>
								<% if @order.confirmed? %>
									Prise en charge confirm√©e
								<% else %>
									<%= simple_form_for(@order, url: admin_order_path(@order) )do |f| %>
								  	<%= f.hidden_field :status, value: "confirmed" %>
								  	<%= submit_tag "Confirmer la prise en charge" , class: "btn btn-secondary",id: "prepare_order", data: {confirm: "Pense bien a revenir valider l'exp√©dition une fois l'article envoy√©" }%>
									<% end %>
								<% end %>
							</td>
							<td>
								<% if @order.confirmed? %>
									<%= link_to "Cr√©er le colissimo üì¶", "https://www.laposte.fr/colissimo-en-ligne"  %>
								<% end %>
							</td>
							<td>
								<% if @order.confirmed? %>
									<%= simple_form_for(@order, url: admin_order_path(@order) )do |f| %>
				        		<%= f.hidden_field :status, value: "full_shipped" %>
				        		<%= submit_tag "Commande exp√©di√©e" , class: "btn btn-secondary"%>
				        	<% end %>
				        <% elsif @order.full_shipped? %>
				        	Exp√©di√©e
								<% end %>
			        </td>
						</tr>
					<% end %>


						<% unless @order.confirmed? || @order.full_shipped? %>
							<tr>
								<td><h1>üôÅ</h1></td>
								<td>
									Un manque ou plus 
								</td>
								<td>
									<% if @order.partly_shipped?  %>
										Client pr√©venu
									<% elsif @order.paid? %>
										<%= link_to "Signaler article(s) manquants", admin_order_order_items_path(@order), class: "btn btn-secondary "%>
									<% end %>
	              </td>
								<td>
									<% if @order.missing_item? %>
										<% unless @order.partially_refunded? %>
											<%= link_to "Rembourser diff√©rence via Stripe", "https://dashboard.stripe.com/test/payments/#{@order.payment_id}", target:"_blank", class: "btn btn-secondary"%>
										<% end %>
									<% elsif @order.partly_shipped? %>
										Vous avez rembours√© et envoy√©
									<% end %>
								</td>
								<td>
									<% if @order.all_is_missing? %>
										<% if @order.totally_refunded? %>
					        		Rembours√©e en totalit√©
					        	<% else %>
											<%= simple_form_for(@order, url: admin_order_path(@order) )do |f| %>
						        		<%= f.hidden_field :status, value: "totally_refunded" %>
						        	  <%= submit_tag "Le remboursement est fait" , class: "btn btn-secondary"%>
											<% end %>
										<% end %>
					        <% elsif @order.missing_item? %>
										<%= simple_form_for(@order, url: admin_order_path(@order) )do |f| %>
					        		<%= f.hidden_field :status, value: "partly_shipped" %>
					        		<%= submit_tag "Commande exp√©di√©e" , class: "btn btn-secondary"%>
					        	<% end %>
					        <% elsif @order.partly_shipped? %>
					         Exp√©di√©e / rembours√©e
				        	<% end %>
								</td>
							</tr>
						<% end %>
					</tbody>
				</table>

		</div>
	</div>

	<div class="row">
		<div class="col-12">
		<p>Commande pass√©e le <%= l(@order.created_at, format: '%d %B %Y' )%></p>
		</div>
	</div>
	<table class="table table-striped">
		<thead>
			<tr>
				<th>Article</th>
				<th>Prix</th>
				<th>Qt√©</th>
				<th>Sous total</th>
			</tr>
		</thead>
		<tbody>
			<% @order.items.each do |item| %>
				<tr>
					<td>
						<%= link_to clients_product_path(item.variant.product) do  %>
							<%= image_tag(item.variant.product.attachments.first.url, class: "small_image") %>
						<% end %>
					</td>
					<td><%= number_to_currency_euro item.price %></td>
					<td>
						<p>Command√©: <%= item.quantity %></p>
						<% if @order.partly_shipped? %>
							<p>Livr√©: <%= item.quantity - item.missing_quantity %></p>
						<% end %>

						<% if item.missing_quantity > 0 %>
							<p>Manquant: <%= item.missing_quantity %></p>
							<p>Rembours√©: <%= item.missing_quantity + (@order.return_asked ? item.returning_item.quantity  : 0 )%></p>
						<% end %>
						<% if item.selected == true %>
						 <p>Retourn√©: <%= item.returning_item.quantity %></p>
						<% end %>
					</td>
					<td><%= number_to_currency_euro item.price * item.quantity %></td>
				</tr>
			<% end %>
		</tbody>
		<tfoot>
			<tr>
				<td colspan='3' align="left">
					Sous total
				</td>
				<td>
					<%= number_to_currency_euro @order.sub_total %>
				</td>
			</tr>
			<tr>
				<td colspan='3' align="left">
					Frais de port
				</td>
				<td>
				 5,00¬†‚Ç¨
				</td>
			</tr>
			<tr>
				<td colspan='3' align="left">
					Total
				</td>
				<td>
				 <%= number_to_currency_euro @order.sub_total + 5 %>
				</td>
			</tr>
		</tfoot>
	</table>
</div>
